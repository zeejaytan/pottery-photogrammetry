project:
  root: /data/gpfs/projects/punim2657/Photogrammetry
  data_root: /data/gpfs/projects/punim2657/Rabati2025
targets:
  min_jpegs_per_tree: 10
  extensions:
  - .jpg
  - .jpeg
  - .JPG
  - .JPEG
  exclude_extensions:
  - .nef
  - .NEF
  - .raw
  - .RAW
  - .psx
  - .zip
  - .oc3
  targets_file: pipeline/targets.txt
paths:
  log_dir: pipeline/logs
environment:
  use_module_system: true
  python_module: Python/3.10.4
  extra_modules:
  - GCC/11.3.0
  - OpenMPI/4.1.4
  - ICU/71.1
  - COLMAP/3.9-CUDA-11.7.0
  colmap_executable: colmap
  openmvs_bin_dir: /data/gpfs/projects/punim2657/Photogrammetry/openmvs/install/bin/OpenMVS
colmap:
  database_name: database.db
  sparse_dir: sparse
  feature_extractor:
    gpu_index: 0
    single_camera: 1                 # Assume single camera for turntable
    use_gpu: 1
    max_image_size: 4096             # Denser keypoints
    max_num_features: 16000          # Increased from 12000 for better matching
    domain_size_pooling: 1           # GPU-safe pooling for smooth surfaces
  exhaustive_matcher:                # Exhaustive ensures cross-ring connections
    gpu_index: 0
    use_gpu: 1
    guided_matching: 1               # Stabilizes geometry across height rings
    num_workers: 16
  mapper:
    init_min_tri_angle: 2.0          # Further relaxed from 4.0 for small-baseline turntable
    abs_pose_min_num_inliers: 15     # Reduced from 20 to accept more images
    abs_pose_min_inlier_ratio: 0.18  # Reduced from 0.20 for small baselines
    ba_refine_focal_length: 1
    ba_refine_principal_point: 0     # Fixed to prevent drift
    ba_refine_extra_params: 1
    num_threads: 8                   # Limit threads for stability
    multiple_models: 0               # Only accept single unified model
  image_undistorter:
    image_path: dense/images
    output_path: dense
    max_image_size: 6000
openmvs:
  cuda_device: 0
  interface:
    image_folder: dense/images      # Undistorted images from COLMAP
  densify:
    resolution_level: 0             # Full resolution (0 = full, 1 = half, etc.)
    number_views: 8                 # Increased from 6 for better coverage
    number_views_fuse: 5            # Increased from 4 for more robust fusion
  reconstruct:
    target_face_num: 10000000       # Very high target for dense mesh
  refine:
    scales: 2                       # Refinement iterations (adds detail)
validation:
  min_vertices: 100000              # Minimum vertices for a valid sherd
  min_component_vertices: 5000      # Increased from 1000 to filter noise
  min_component_area: 10.0          # Increased from 1.0 to filter thin artifacts
  max_components: 40                # Safety limit for large fragmented pottery
coded_targets:
  enabled: false                    # Enable coded target workflow
  board_type: aruco                 # "aruco" or "charuco"
  dictionary: DICT_4X4_50           # ArUco dictionary
  square_size_mm: 50.0              # Real-world square size (mm)

  # ChArUco board dimensions (if board_type: charuco)
  board_width: 5                    # Squares in width
  board_height: 7                   # Squares in height

  # Pairing parameters
  pairing:
    min_shared_markers: 1           # Minimum shared markers for pair
    temporal_window: 3              # Sequential neighbor window

  # Alignment parameters
  alignment:
    method: auto                    # "auto", "poses", "scale_only"
    min_board_views: 10             # Minimum images with board visible
    robust_alignment: true          # Use RANSAC in model_aligner
manual_scale:
  enabled: false                    # Enable manual scale workflow
  export_after_mapper: false        # Auto-export sparse after mapper
  sanity_bounds:
    min_scale: 0.01                 # Minimum allowed scale factor
    max_scale: 100.0                # Maximum allowed scale factor
  agreement_tolerance_pct: 2.0      # Max disagreement between two measurements (%)
  prefer_scaled_sparse: true        # Use sparse_scaled/0 if it exists
  dense_output_name: dense_scaled   # Output directory for scaled dense
aruco_scale:
  enabled: false                    # Enable ArUco scale workflow
  dictionary: DICT_4X4_50           # ArUco dictionary
  auto_run: false                   # Auto-run after mapper (requires --idA/--idB/--real-m in env)
  sanity_bounds:
    min_scale: 0.01                 # Minimum allowed scale factor
    max_scale: 100.0                # Maximum allowed scale factor
  prefer_aruco_scale: true          # Prefer ArUco scale over manual/coded targets
mesh_splitter:
  enabled: false                    # Enable mesh splitting after RefineMesh
  auto_run: false                   # Auto-run after RefineMesh in batch
  min_faces: 5000                   # Minimum face count to keep component
  max_elongation: 25.0              # Maximum elongation ratio (max_dim / min_dim)
  bridge_quantile: 0.995            # Edge length quantile for bridge breaking
  output_dir: split_sherds          # Output directory name
  format: ply                       # Output format: 'ply' or 'obj'
  keep_all: false                   # Keep all components (only min_faces filter)
  keep_top: null                    # Keep only top N largest (null = disabled)
maskbuild:
  quick_build:
    # Feature extraction (faster than main pipeline)
    max_image_size: 2048            # 50% of main pipeline (4096)
    max_num_features: 8000          # 50% of main pipeline (16000)
    # Matching (same strategy as main)
    matcher: exhaustive             # Still need cross-ring connections
    guided_matching: 1
    # Mapper (more lenient than main)
    mapper_min_tri_angle: 2.0       # Same as main
    mapper_min_inliers: 12          # Lower than main (15)
    mapper_min_inlier_ratio: 0.15   # Lower than main (0.18)
    # Dense reconstruction (low-resolution)
    undistort_max_image_size: 2048
    densify_resolution_level: 2     # 1/4 resolution (main: 0 = full)
    densify_number_views: 4         # Fewer than main (8)
    densify_number_views_fuse: 3    # Fewer than main (5)
    # Mesh (simplified)
    reconstruct_simplify: 0.5       # Target 50% face reduction
  projection:
    # Mask generation parameters
    pad_pixels: 2                   # Protect thin rims
    erosion: 0                      # Set to 1 if halos appear
    # Frame validation thresholds
    bbox_tolerance: 0.1             # 10% bbox shrinkage OK
    distance_tolerance: 0.05        # 5% distance error OK
slurm:
  account: punim2657
  partition: gpu-a100
  qos: normal
  time_hours: 12
  mem_gb: 64
  gpus: 1
  gres: gpu:A100:1
  cpus_per_task: 8
  array_chunk: 4
  mail_user: ''
  mail_type: NONE
